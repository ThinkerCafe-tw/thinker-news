name: æ¨¡åž‹å“è³ªæ¯”è¼ƒå¯¦é©—

on:
  workflow_dispatch:
    inputs:
      sample_size:
        description: 'æŠ½æ¨£æ–°èžæ•¸é‡'
        required: false
        default: '3'
      date:
        description: 'æ¸¬è©¦æ—¥æœŸ (YYYY-MM-DDï¼Œç•™ç©ºç”¨ä»Šå¤©)'
        required: false
        default: ''

jobs:
  compare:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install openai anthropic google-generativeai feedparser requests

      - name: Fetch & Filter News
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          DATE="${{ github.event.inputs.date }}"
          if [ -z "$DATE" ]; then
            DATE=$(date +%Y-%m-%d)
          fi
          echo "DATE=$DATE" >> $GITHUB_ENV
          
          python3 -c "
          from scripts.rss_fetcher import fetch_all_feeds
          from scripts.news_filter import filter_and_score_news
          import json
          from pathlib import Path

          date = '$DATE'
          print(f'ðŸ“¡ æŠ“å– RSS feeds...')
          feeds = fetch_all_feeds()
          print(f'   å…± {len(feeds)} å‰‡')

          print(f'ðŸ” ç¯©é¸ä¸­...')
          filtered = filter_and_score_news(feeds, date)
          print(f'   ç¯©é¸å¾Œ {len(filtered)} å‰‡')

          data_dir = Path('data')
          data_dir.mkdir(exist_ok=True)
          path = data_dir / f'filtered_{date}.json'
          with open(path, 'w', encoding='utf-8') as f:
              json.dump(filtered, f, ensure_ascii=False, indent=2)
          print(f'ðŸ’¾ å·²ä¿å­˜: {path}')
          "

      - name: Run Model Comparison
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python3 scripts/compare_models.py ${{ env.DATE }} ${{ github.event.inputs.sample_size || '3' }}

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: experiment-results-${{ env.DATE }}
          path: |
            experiments/
            data/
          retention-days: 30

      - name: Summary
        run: |
          echo "## ðŸ§ª å¯¦é©—çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "experiments/compare_${{ env.DATE }}.json" ]; then
            echo "âœ… å¯¦é©—å®Œæˆï¼Œçµæžœå·²ä¸Šå‚³è‡³ Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            head -100 "experiments/compare_${{ env.DATE }}.json" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å¯¦é©—å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ logs" >> $GITHUB_STEP_SUMMARY
          fi
